<script>
/* ================================
   CONFIGURACIÓN SEGURA
================================ */
const HASH_GUIA_AUTORIZADA = "c9c7c9f9e63b5b1f5f9e7a94e8e8b0a4";
const NUMERO_WHATSAPP = "573508995621";
const MAX_INTENTOS = 3;

/* ================================
   UTILIDADES
================================ */
function hashGuia(valor) {
  let hash = 0;
  for (let i = 0; i < valor.length; i++) {
    hash = ((hash << 5) - hash) + valor.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash).toString(16);
}

function registrarIntentoFallido() {
  const intentos = parseInt(localStorage.getItem("intentosFallidos")) || 0;
  localStorage.setItem("intentosFallidos", intentos + 1);
}

/* ================================
   FUNCIÓN PRINCIPAL
================================ */
function verificarGuia() {
  const guia = document.getElementById("guia").value.trim();
  const estado = document.getElementById("estado");
  const loader = document.getElementById("loader");
  const boton = document.getElementById("btnConsultar");

  // Reset visual
  estado.className = "estado";
  estado.textContent = "";
  estado.style.opacity = "1";
  loader.style.display = "none";

  // Validación campo vacío
  if (!guia) {
    estado.textContent = "Debe ingresar el número de guía.";
    estado.classList.add("error");
    return;
  }

  // Control de intentos
  const intentos = parseInt(localStorage.getItem("intentosFallidos")) || 0;
  if (intentos >= MAX_INTENTOS) {
    estado.textContent = "Acceso bloqueado por intentos fallidos.";
    estado.classList.add("error");
    boton.disabled = true;
    return;
  }

  // Estado verificando
  boton.disabled = true;
  loader.style.display = "block";
  estado.textContent = "Verificando guía…";

  setTimeout(() => {
    const hashIngresado = hashGuia(guia);

    // Guía incorrecta
    if (hashIngresado !== HASH_GUIA_AUTORIZADA) {
      loader.style.display = "none";
      estado.textContent = "Guía no autorizada.";
      estado.classList.add("error");
      registrarIntentoFallido();
      boton.disabled = false;
      return;
    }

    // Guía correcta
    loader.style.display = "none";
    estado.textContent = "Guía validada. Redirigiendo…";
    estado.classList.add("ok");

    setTimeout(() => {
      window.location.href =
        "https://wa.me/" +
        NUMERO_WHATSAPP +
        "?text=" +
        encodeURIComponent(
          "Hola, realizo consulta de DEPÓSITO ASEGURADO. Guía autorizada."
        );
    }, 1000);

  }, 1500);
}

/* ================================
   REGISTRO PWA (OPCIONAL)
================================ */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>
